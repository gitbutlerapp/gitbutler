<script lang="ts">
	import IconTriangleUp from '$lib/icons/IconTriangleUp.svelte';
	import IconTriangleDown from '$lib/icons/IconTriangleDown.svelte';
	import { type ComponentType, getContext } from 'svelte';
	import lscache from 'lscache';
	import { SETTINGS_CONTEXT, type SettingsStore } from '$lib/settings/userSettings';
	import { slide } from 'svelte/transition';
	import Scrollbar from '$lib/components/Scrollbar.svelte';
	import Resizer from '$lib/components/Resizer.svelte';

	interface Tab {
		name: string;
		displayName: string;
		component: ComponentType;
		props: any;
	}

	const userSettings = getContext<SettingsStore>(SETTINGS_CONTEXT);
	const treeHeightKey = 'treeHeight:';
	const activeTabKey = 'activeTab:';
	const expandedKey = 'expanded:';

	export let items: Tab[] = [];
	export let branchId: string;

	$: expanded = branchId ? Boolean(lscache.get(expandedKey + branchId)) : false;
	$: activeTabValue = lscache.get(activeTabKey + branchId) ?? items[0].name;
	$: treeHeight = lscache.get(treeHeightKey + branchId) || $userSettings.defaultTreeHeight;

	let thViewport: HTMLElement;
	let thContents: HTMLElement;

	function setTreeExpanded(value: boolean) {
		expanded = value;
		lscache.set(expandedKey + branchId, expanded, 7 * 1440);
	}

	function setActiveTab(value: string) {
		activeTabValue = value;
		lscache.set(activeTabKey + branchId, activeTabValue, 7 * 1440);
	}
</script>

<div style:background-color="var(--bg-surface-highlight)">
	<div
		class="text-color-3 border-color-4 flex w-full border-b border-t"
		style:border-color="var(--border-surface)"
	>
		{#each items as item}
			<button
				class:text-color-1={activeTabValue == item.name}
				class="-mb-px rounded-none p-2 font-medium"
				on:click={() => {
					if (activeTabValue == item.name && expanded) {
						setTreeExpanded(false);
						setActiveTab('');
						return;
					}
					setTreeExpanded(true);
					setActiveTab(item.name);
				}}
			>
				{item.displayName}
			</button>
		{/each}
		<div class="flex-grow" />
		<button
			class="text-color-3 hover:text-color-2 flex items-center gap-x-4 py-0"
			on:click|stopPropagation={() => {
				setTreeExpanded(!expanded);
			}}
		>
			<div class="pr-3">
				{#if expanded}
					<IconTriangleUp />
				{:else}
					<IconTriangleDown />
				{/if}
			</div>
		</button>
	</div>
	{#if expanded}
		<div class="relative border-b" style:border-color="var(--border-surface)">
			<div
				class="hide-native-scrollbar relative shrink-0 overflow-scroll overscroll-none bg-white dark:bg-dark-1000"
				transition:slide|local={{ duration: 250 }}
				style:height={`${treeHeight}px`}
				bind:this={thViewport}
			>
				<div bind:this={thContents} class="h-full">
					{#each items as item}
						{#if activeTabValue == item.name}
							<svelte:component this={item.component} {...item.props} />
						{/if}
					{/each}
				</div>
			</div>
			<Scrollbar viewport={thViewport} contents={thContents} thickness="0.4rem" />
		</div>
	{/if}
</div>
<Resizer
	viewport={thViewport}
	direction="down"
	on:height={(e) => {
		treeHeight = e.detail;
		lscache.set(treeHeightKey + branchId, e.detail, 7 * 1440); // 7 day ttl
		userSettings.update((s) => ({ ...s, defaultTreeHeight: e.detail }));
	}}
/>
