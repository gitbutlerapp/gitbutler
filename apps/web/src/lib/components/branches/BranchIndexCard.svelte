<script lang="ts">
	import TableRow from '$lib/components/table/TableRow.svelte';
	import { BranchService } from '@gitbutler/shared/branches/branchService';
	import { getBranchReview } from '@gitbutler/shared/branches/branchesPreview.svelte';
	import { getBranchStatusBadge } from '@gitbutler/shared/branches/getBranchStatusBadge';
	import { getContributorsWithAvatars } from '@gitbutler/shared/branches/types';
	import { getContext } from '@gitbutler/shared/context';
	import Loading from '@gitbutler/shared/network/Loading.svelte';
	import { isFound } from '@gitbutler/shared/network/loadable';
	import { AppState } from '@gitbutler/shared/redux/store.svelte';
	import {
		WebRoutesService,
		type ProjectParameters
	} from '@gitbutler/shared/routing/webRoutes.svelte';
	import dayjs from 'dayjs';
	import relativeTime from 'dayjs/plugin/relativeTime';

	dayjs.extend(relativeTime);

	type Props = {
		uuid: string;
		linkParams: ProjectParameters;
		roundedTop: boolean;
		roundedBottom: boolean;
	};

	const { uuid, linkParams, roundedTop, roundedBottom }: Props = $props();

	const appState = getContext(AppState);
	const branchService = getContext(BranchService);
	const routes = getContext(WebRoutesService);

	const branch = $derived(getBranchReview(appState, branchService, uuid));

	let contributors = $state<Array<{ srcUrl: string; name: string }>>([]);

	$effect(() => {
		(async () => {
			contributors = isFound(branch.current)
				? await getContributorsWithAvatars(branch.current.value)
				: [];
		})();
	});
</script>

<Loading loadable={branch.current}>
	{#snippet children(branch)}
		<TableRow
			href={routes.projectReviewBranchPath({ ...linkParams, branchId: branch.branchId })}
			columns={[
				{ key: 'status', value: getBranchStatusBadge(branch) },
				{ key: 'title', value: branch.title || '-', tooltip: branch.title },
				{ key: 'number', value: branch.branchId.slice(0, 7), tooltip: branch.branchId },
				{ key: 'commitGraph', value: branch },
				{ key: 'date', value: branch.updatedAt },
				{ key: 'avatars', value: contributors },
				{ key: 'number', value: branch.version || 0 }
			]}
			separatedTop={roundedTop}
			separatedBottom={roundedBottom}
		/>
	{/snippet}
</Loading>
