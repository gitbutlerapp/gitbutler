<script lang="ts">
	import { StackService } from '$lib/stacks/stackService.svelte';
	import { inject } from '@gitbutler/shared/context';
	import Button from '@gitbutler/ui/Button.svelte';
	import Modal from '@gitbutler/ui/Modal.svelte';
	import Textbox from '@gitbutler/ui/Textbox.svelte';

	type Props = {
		projectId: string;
		stackId: string;
		branchName: string;
		isPushed: boolean;
	};

	const { projectId, stackId, branchName, isPushed }: Props = $props();
	const [stackService] = inject(StackService);

	const [renameBranch, renameResult] = stackService.updateBranchName;

	let newName: string | undefined = $state();
	let modal: Modal | undefined = $state();

	export function show() {
		modal?.show();
	}
</script>

<Modal
	width="small"
	title={isPushed ? 'Branch has already been pushed' : 'Rename branch'}
	type={isPushed ? 'warning' : 'info'}
	bind:this={modal}
	onSubmit={async (close) => {
		if (newName) {
			renameBranch({ projectId, stackId, branchName, newName });
		}
		close();
	}}
>
	<Textbox placeholder="New name" id="newSeriesName" bind:value={newName} autofocus />

	{#if isPushed}
		<div class="text-12 helper-text">
			Renaming a branch that has already been pushed will create a new branch at the remote. The old
			one will remain untouched but will be disassociated from this branch.
		</div>
	{/if}

	{#snippet controls(close)}
		<Button kind="outline" type="reset" onclick={close}>Cancel</Button>
		<Button style="pop" type="submit" disabled={!newName} loading={renameResult.current.isLoading}
			>Rename</Button
		>
	{/snippet}
</Modal>

<style lang="postcss">
	.helper-text {
		margin-top: 1rem;
		color: var(--clr-scale-ntrl-50);
		line-height: 1.5;
	}
</style>
