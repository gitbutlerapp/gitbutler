description: "Tier 4 integration tests for the GitButler but skill"

prompts:
  - "{{prompt}}"

providers:
  - id: file://dist/providers/but-integration.js
    config:
      model: "claude-sonnet-4-5-20250929"
      max_turns: 25
      max_budget_usd: 1.0
      keep_fixtures: false

defaultTest:
  vars:
    setup_commands: ""

tests:
  - description: "Basic commit flow: status then commit with required flags"
    vars:
      prompt: "Commit src/auth.rs with message 'Add auth skeleton'."
      setup_commands: |
        mkdir -p src
        cat <<'EOF' > src/auth.rs
        pub fn auth() {}
        EOF
    assert:
      - type: javascript
        value: file://assertions/but-assertions.ts:basicCommitFlow

  - description: "Branch workflow: create branch before committing"
    vars:
      prompt: "Create a branch called dark-mode and commit src/theme.rs with a clear message."
      setup_commands: |
        mkdir -p src
        cat <<'EOF' > src/theme.rs
        pub fn dark_mode() {}
        EOF
    assert:
      - type: javascript
        value: file://assertions/but-assertions.ts:branchWorkflow

  - description: "Git synonym redirect: user asks for git push, agent uses but push"
    vars:
      prompt: "Can you do a git push?"
      setup_commands: |
        mkdir -p .tmp
        git init --bare .tmp/origin.git
        git remote add origin .tmp/origin.git
    assert:
      - type: javascript
        value: file://assertions/but-assertions.ts:gitSynonymRedirect

  - description: "Ordering: but status happens before but commit"
    vars:
      prompt: "Commit src/main.rs with a useful commit message."
      setup_commands: |
        mkdir -p src
        cat <<'EOF' > src/main.rs
        fn main() {}
        EOF
    assert:
      - type: javascript
        value: file://assertions/but-assertions.ts:orderingFlow

  - description: "Specificity: commit uses --changes when only one file should be committed"
    vars:
      prompt: "Commit only src/a.rs, and do not include src/b.rs."
      setup_commands: |
        mkdir -p src
        cat <<'EOF' > src/a.rs
        pub fn a() {}
        EOF
        cat <<'EOF' > src/b.rs
        pub fn b() {}
        EOF
    assert:
      - type: javascript
        value: file://assertions/but-assertions.ts:specificityFlow

  - description: "Amend flow: amend file into existing commit with but amend"
    vars:
      prompt: "Amend src/a.rs into the existing commit on branch amend-test. Use but amend."
      setup_commands: |
        mkdir -p src
        cat <<'EOF' > src/a.rs
        pub fn a() {
          println!("one");
        }
        EOF
        but branch new amend-test
        but commit amend-test -m "Add a.rs" --json --status-after
        cat <<'EOF' > src/a.rs
        pub fn a() {
          println!("two");
        }
        EOF
    assert:
      - type: javascript
        value: file://assertions/but-assertions.ts:amendFlow

  - description: "Reorder flow: use but history editing to reorder commits"
    vars:
      prompt: "Reorder commits on branch reorder-test so the commit adding src/first.rs is before the one adding src/second.rs. Use GitButler commands, not git rebase."
      setup_commands: |
        mkdir -p src
        cat <<'EOF' > src/second.rs
        pub fn second() {}
        EOF
        but branch new reorder-test
        but commit reorder-test -m "Add second.rs" --json --status-after
        cat <<'EOF' > src/first.rs
        pub fn first() {}
        EOF
        but commit reorder-test -m "Add first.rs" --json --status-after
    assert:
      - type: javascript
        value: file://assertions/but-assertions.ts:reorderFlow
