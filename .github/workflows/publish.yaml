name: "Publish"
on:
    workflow_dispatch: {}
    pull_request: {}

jobs:
    publish-tauri:
        strategy:
            fail-fast: false
            matrix:
                platform:
                    # - macos-latest
                    - macos-aarch64

        runs-on: ${{ matrix.platform }}
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: 18

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 7.x.x
                  run_install: |
                      args: ["--frozen-lockfile"]

            - name: Setup rust
              uses: dtolnay/rust-toolchain@stable

            - name: Build and upload
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              run: |
                  ./scripts/release.sh \
                    --sign \
                    --tauri-private-key          "${{ secrets.TAURI_PRIVATE_KEY }}"  \
                    --tauri-key-password         "${{ secrets.TAURI_KEY_PASSWORD }}" \
                    --apple-certificate          "${{ secrets.APPLE_CERTIFICATE }}" \
                    --apple-certificate-password "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" \
                    --apple-signing-identity     "${{ secrets.APPLE_SIGNING_IDENTITY }}" \
                    --apple-id                   "${{ secrets.APPLE_ID }}" \
                    --apple-password             "${{ secrets.APPLE_PASSWORD }}"
